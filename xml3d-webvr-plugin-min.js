/*! xml3d-webvr-plugin.js v0.0.1 | (c) 2013-2016 DFKI GmbH and contributors, www.dfki.de | https://raw.githubusercontent.com/xml3d/xml3d.js/master/LICENSE */(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
function fieldOfViewToProjectionMatrix(e,t,r){var a=Math.tan(e.upDegrees*Math.PI/180),o=Math.tan(e.downDegrees*Math.PI/180),i=Math.tan(e.leftDegrees*Math.PI/180),n=Math.tan(e.rightDegrees*Math.PI/180),f=2/(i+n),v=2/(a+o),l=new Float32Array(16);l[0]=f,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=v,l[6]=0,l[7]=0,l[8]=-((i-n)*f*.5),l[9]=(a-o)*v*.5,l[10]=-(t+r)/(r-t),l[11]=-1,l[12]=0,l[13]=0,l[14]=-(2*r*t)/(r-t);var g=-3.40282347e38;return l[14]=Number.isFinite(l[14])?l[14]:g,l[15]=0,l}function arrayToString(e){for(var t="",r=0;r<e.length;r++)t=t+" "+e[r].toString();return t}var fov=module.exports={};fov.initializeFOV=function(){for(var e=$("#vr_view"),t=new Float32Array(16),r=0;r<16;r++)t[r]=0;var a="<float4x4 name='projectionMatrix'>"+arrayToString(t)+"</float4x4>";e.attr("model","urn:xml3d:view:projective"),e.append(a)},fov.setFOV=function(e,t,r){var a,o,i,n=e.getViewMatrix(),f=t.getWorldBoundingBox();f.transformAxisAligned(n),o=-f.max.z,i=-f.min.z,(o<1||o==1/0||o==-(1/0))&&(o=1),i!=1/0&&i!=-(1/0)||(i=1e3),a=HMD.getEyeParameters("right").fieldOfView;var v=fieldOfViewToProjectionMatrix(a,o,i);r.textContent=arrayToString(v)},fov.resetFOV=function(){var e=$("view");e.removeAttr("model"),document.querySelector("float4x4[name=projectionMatrix]").remove()};

},{}],2:[function(require,module,exports){
(function (global){
function getActiveView(){var e=document.getElementsByTagName("xml3d")[0],r=e.view;if(r)return document.getElementById(r.substr(1))}var render=module.exports={},fov=require("./fov.js");window.XML3D.webvr={},window.XML3D.webvr.translationScale=3;var eyeScale=10,oldRenderTree,oldView;render.vrRenderTree=function(){console.log("creating custom render tree");try{var e=new Stats;e.showPanel(0),document.body.appendChild(e.dom)}catch(r){var e={};e.begin=function(){},e.end=function(){}}var r=HMD.getEyeParameters("left"),t=HMD.getEyeParameters("right"),a=r.offset,n=t.offset,s=$("#"+document.getElementsByTagName("xml3d")[0].view.substr(1));0==$("#headTransformGroup").length&&0==$("#eyeTransform").length&&(s.attr("transform")?(s.before('<group id="oldCameraTransform"><group id="headTransformGroup"><group id="eyeTransform"><view id="vr_view"></view></group></group></group>'),$("#oldCameraTransform").attr("transform",s.attr("transform"))):s.before('<group id="headTransformGroup"><group id="eyeTransform"><view id="vr_view"></view></group></group>'));var o=$("#eyeTransform"),i=$("#headTransformGroup");0==$("#headTransform").length&&i.before('<transform id="headTransform"></transform>'),i.attr("transform","#headTransform");var d=$("#headTransform");0==$("#leftEyeTransform").length&&0==$("#rightEyeTransform").length&&0==$("#defaultEyeTransform").length&&(o.before('<transform id="leftEyeTransform" translation="'+a[0]*eyeScale+" "+a[1]*eyeScale+" "+a[2]*eyeScale+'"></transform>'),o.before('<transform id="rightEyeTransform" translation="'+n[0]*eyeScale+" "+n[1]*eyeScale+" "+n[2]*eyeScale+'"></transform>'),o.before('<transform id="defaultEyeTransform" translation="0 0 0"></transform>')),gl.canvas.width=r.renderWidth+t.renderWidth,gl.canvas.height=Math.max(r.renderHeight,t.renderHeight),console.log("Canvas: "+gl.canvas.width+", "+gl.canvas.height),gl.enable(gl.SCISSOR_TEST),fov.initializeFOV();var l=document.getElementsByTagName("xml3d")[0],g=document.querySelector("float4x4[name=projectionMatrix]");oldView=l.getAttribute("view"),l.setAttribute("view","#vr_view");var s=getActiveView(),c=[0,0,0],f=[0,0,0,1],m=function(e,r,t){XML3D.webgl.BaseRenderPass.call(this,e,r,t)};XML3D.createClass(m,XML3D.webgl.BaseRenderPass),XML3D.extend(m.prototype,{render:function(e){var r=this.renderInterface.context.gl;this.output.bind(),r.clear(r.COLOR_BUFFER_BIT),r.disable(r.DEPTH_TEST),this.output.unbind(),r.enable(r.DEPTH_TEST)},setProcessed:function(e){this.processed=e,this.prePasses[0].processed=e,this.prePasses[1].processed=e},renderTree:function(r){if(!this.processed){this.processed=!0,e.begin();var t=HMD.getPose(),a=t.orientation?t.orientation:[0,0,0,1];a[0]=a[0]?a[0]:f[0],a[1]=a[1]?a[1]:f[1],a[2]=a[2]?a[2]:f[2],a[3]=a[3]?a[3]:f[3],f=a;var n=new XML3D.AxisAngle.fromQuat(new XML3D.Quat(a[0],a[1],a[2],a[3])),i=n.axis.x+" "+n.axis.y+" "+n.axis.z+" "+n.angle;d.attr("rotation",i);var m=t.position?t.position:[0,0,0];m[0]=m[0]?m[0]:c[0],m[1]=m[1]?m[1]:c[1],m[2]=m[2]?m[2]:c[2],c=m;var h=m[0]*window.XML3D.webvr.translationScale+" "+m[1]*window.XML3D.webvr.translationScale+" "+m[2]*window.XML3D.webvr.translationScale;d.attr("translation",h),fov.setFOV(s,l,g);var v=HMD.getEyeParameters("left"),u=HMD.getEyeParameters("right"),T=this.prePasses.length;if(2==T){var w=this.prePasses[0],p=this.prePasses[1];o.attr("transform","#leftEyeTransform"),gl.scissor(0,0,v.renderWidth,v.renderHeight),gl.viewport(0,0,v.renderWidth,v.renderHeight),XML3D.flushDOMChanges(),p.render(r),o.attr("transform","#rightEyeTransform"),gl.scissor(v.renderWidth,0,u.renderWidth,u.renderHeight),gl.viewport(v.renderWidth,0,u.renderWidth,u.renderHeight),XML3D.flushDOMChanges(),w.render(r)}else for(;T--;)this.prePasses[T].renderTree(r);e.end(),HMD.submitFrame(t)}}});var h=function(e){XML3D.webgl.BaseRenderTree.call(this,e),this.createRenderPasses()};XML3D.createClass(h,XML3D.webgl.BaseRenderTree),XML3D.extend(h.prototype,{createRenderPasses:function(){var e=this.renderInterface.context,r=function(){};global.oldBind=e.canvasTarget.__proto__.bind,console.log(oldBind),e.canvasTarget.__proto__.bind=r;var t=this.renderInterface.createSceneRenderPass(),a=this.renderInterface.createSceneRenderPass(),n={},s=new m(this.renderInterface,e.canvasTarget,n);s.addPrePass(a),s.addPrePass(t),this.mainRenderPass=s},render:function(e){this.mainRenderPass.setProcessed(!1),XML3D.webgl.BaseRenderTree.prototype.render.call(this,e)}});var v=document.getElementsByTagName("xml3d")[0],u=v.getRenderInterface();oldRenderTree=u.getRenderTree();var T=new h(u);u.setRenderTree(T),XML3D.options.setValue("renderer-continuous",!0)},render.resetRenderTree=function(){gl.disable(gl.SCISSOR_TEST),fov.resetFOV();var e=document.getElementsByTagName("xml3d")[0],r=e.getBoundingClientRect(),t=e.getRenderInterface(),a=t.context;a.canvasTarget.__proto__.bind=global.oldBind,gl.canvas.width=r.width,gl.canvas.height=r.height,gl.viewport(0,0,gl.canvas.width,gl.canvas.height),e.getRenderInterface().setRenderTree(oldRenderTree),e.setAttribute("view",oldView),$("#headTransformGroup").remove(),$("#oldCameraTransform").remove()};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./fov.js":1}],3:[function(require,module,exports){
(function (global){
function resetPosition(){HMD&&HMD.resetPose()}var utility=module.exports={},render=require("./render_viewports.js"),orig_requestAnimationFrame=window.requestAnimationFrame;utility.initiateVR=function(){console.log("Entering VR!"),HMD=global.devices[0],console.log(HMD),myCanvas=document.getElementsByClassName("_xml3d")[0],console.log(myCanvas),gl=myCanvas.getContext("webgl"),HMD.requestPresent([{source:myCanvas}]),render.vrRenderTree(),window.requestAnimationFrame=function(e){HMD.requestAnimationFrame(e)}},utility.setupButtons=function(){var e={width:"10rem","border -width":"0px",cursor:"pointer","font-family":'"Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif',"font-weight":"normal","line-height":"normal",margin:"0 0 0rem",position:"relative","text-decoration":"none","text-align":"center",display:"inline-block","padding-top":"1rem","padding-right":"1rem","padding-bottom":"1rem","padding-left":"1rem","font-size":"1rem","background-color":"#008cba",color:"white",transition:"background-color 300ms ease-out"};$("body").append("<div id='ButtonBar' style='position: fixed; bottom: 0px'></div>"),utility.addVRenableBtn(e)},utility.addVRenableBtn=function(e){$("#ButtonBar").append("<button id='VRenable'>Enter VR</button>"),$("#VRenable").css(e),document.getElementById("VRenable").addEventListener("click",function(){global.inVR?(HMD.exitPresent(),render.resetRenderTree(),$("#VRenable").html("Enter VR"),$("#ResetPos").remove(),global.inVR=!1):(utility.initiateVR(),$("#VRenable").html("Exit VR"),utility.addResetBtn(e),global.inVR=!0)})},utility.addResetBtn=function(e){$("#ButtonBar").append("<button id='ResetPos'>Reset Position</button>"),$("#ResetPos").css(e),document.getElementById("ResetPos").addEventListener("click",function(){resetPosition()})};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./render_viewports.js":2}],4:[function(require,module,exports){
(function (global){
"use strict";var util=require("./utility.js");$(document).ready(function(){navigator.getVRDisplays().then(function(t){return t.length<1?void console.log("No VRDisplays found, reload page to try again"):(global.devices=t,void util.setupButtons())})});var HMD,gl,myCanvas;global.inVR=!1;
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./utility.js":3}]},{},[4]);
